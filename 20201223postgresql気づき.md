### 問題点

- 配信済みの通知について、再度「配信する」を押下してapiをコールすると失敗するが<br>
配信成功した際に更新されるDBのテーブルのidのシーケンスが増加してしまう。

---

### 検証

- 該当idのcolumn_default（table plusのstructureタブより確認）

```
nextval('xxxxx_id_seq'::regclass)
```

- シーケンス増加の確認方法

```
select nextval('xxxxx_id_seq')
```

で、postgres上のシーケンス次の採番される値を表示させる<br>
（SQLアイコンからターミナル画面を出してコマンド入れる　＞　Run currentを押して実行）<br>
→　失敗した分+1されていた（DBにあるid最大値の次の数値ではなく1飛んだ値）<br>
<br>
参考記事：https://qiita.com/5zm/items/da82cec73e097d2a97d0

---

### 原因

>重要項目: 同一のシーケンスから数値を取得する同時実行トランザクション同士のブロックを防止するため、
>nextval演算は決してロールバックされません。
>と言うことは、たとえnextvalを実行したトランザクションが後にアボートしたとしても、
>値が一度取り出されたらそれは使用されたものと考えます。
>つまり、アボートされたトランザクションは、割り当てられた値のシーケンス内に未使用の“欠損“を残す可能性があります。
>setval演算についても同じくロールバックしません。

https://www.postgresql.jp/document/9.0/html/functions-sequence.html<br>

---

### 対応

これに対策を取ろうと思うと、where句使ったりなどでパフォーマンス低下するとの事だったので<br>
今回は仕様としておく事に。
